<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Slots - Dynatrace Casino</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Enhanced Smartscape-inspired background */
        .slots-bg {
            background: 
                radial-gradient(circle at 10% 20%, rgba(108, 44, 156, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
        }
        
        .slot-machine-container {
            background: 
                radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 70% 70%, rgba(255, 215, 0, 0.05) 0%, transparent 50%),
                linear-gradient(145deg, rgba(21, 21, 21, 0.95), rgba(45, 45, 45, 0.8));
            border: 4px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 0 0 2px #DAA520,
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(218, 165, 32, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }
        
        .slot-machine-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(218, 165, 32, 0.06) 0%, transparent 35%);
            pointer-events: none;
        }
        
        .slot-reel {
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.15) 0%, transparent 40%),
                linear-gradient(180deg, #2D2D2D 0%, #1A1A1A 30%, #2D2D2D 70%, #1A1A1A 100%);
            border: 3px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 0 0 2px #8B4513,
                inset 0 4px 15px rgba(0, 0, 0, 0.9),
                inset 0 -4px 15px rgba(139, 69, 19, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.6),
                0 0 20px rgba(139, 69, 19, 0.4);
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .slot-reel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                transparent 30%,
                rgba(218, 165, 32, 0.1) 70%,
                transparent 100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            border-radius: 10px;
        }
        
        .slot-reel:hover::before {
            opacity: 1;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                rgba(218, 165, 32, 0.15) 50%,
                rgba(255, 215, 0, 0.1) 100%);
        }
        
        .slot-symbol {
            font-size: 3rem;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.8);
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
            transition: all 0.3s ease;
        }
        
        .spinning .slot-symbol {
            animation: casino-reel-spin 0.08s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            filter: blur(3px) brightness(1.2);
            transform-style: preserve-3d;
        }
        
        @keyframes casino-reel-spin {
            0% { 
                transform: translateY(0) rotateX(0deg); 
                opacity: 1;
            }
            50% { 
                transform: translateY(-50%) rotateX(90deg); 
                opacity: 0.7;
            }
            100% { 
                transform: translateY(-100%) rotateX(180deg); 
                opacity: 1;
            }
        }
        
        .winning-reel {
            border: 4px solid #FFD700 !important;
            box-shadow: 
                0 0 0 2px #FFFFFF,
                0 0 40px rgba(255, 215, 0, 1),
                0 0 80px rgba(255, 215, 0, 0.6),
                inset 0 4px 15px rgba(255, 255, 255, 0.3),
                inset 0 -4px 15px rgba(255, 215, 0, 0.2) !important;
            animation: casino-win-pulse 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite alternate;
        }
        
        .winning-reel .slot-symbol {
            animation: win-celebrate 1s ease-in-out infinite alternate;
            text-shadow: 0 0 30px rgba(115, 190, 40, 1);
        }
        
        @keyframes casino-win-pulse {
            0% { 
                transform: scale(1);
                box-shadow: 
                    0 0 0 2px #FFFFFF,
                    0 0 40px rgba(255, 215, 0, 1),
                    0 0 80px rgba(255, 215, 0, 0.6),
                    inset 0 4px 15px rgba(255, 255, 255, 0.3);
            }
            100% { 
                transform: scale(1.08);
                box-shadow: 
                    0 0 0 3px #FFFFFF,
                    0 0 60px rgba(255, 215, 0, 1.2),
                    0 0 120px rgba(255, 215, 0, 0.8),
                    inset 0 4px 20px rgba(255, 255, 255, 0.4);
            }
        }
        
        @keyframes win-celebrate {
            0% { transform: scale(1) rotate(-1deg); }
            100% { transform: scale(1.1) rotate(1deg); }
        }
        
        /* Enhanced Symbol Rarity Effects */
        .rarity-legendary {
            animation: legendary-glow 2s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 15px rgba(255, 210, 63, 0.8));
        }
        
        .rarity-epic {
            animation: epic-pulse 1.5s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 10px rgba(108, 44, 156, 0.6));
        }
        
        .rarity-rare {
            filter: drop-shadow(0 0 8px rgba(0, 161, 201, 0.4));
        }
        
        .rarity-common {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
        }
        
        @keyframes legendary-glow {
            0% { 
                transform: scale(1);
                filter: drop-shadow(0 0 15px rgba(255, 210, 63, 0.8)) hue-rotate(0deg);
            }
            100% { 
                transform: scale(1.05);
                filter: drop-shadow(0 0 25px rgba(255, 210, 63, 1)) hue-rotate(30deg);
            }
        }
        
        @keyframes epic-pulse {
            0% { 
                transform: scale(1);
                filter: drop-shadow(0 0 10px rgba(108, 44, 156, 0.6));
            }
            100% { 
                transform: scale(1.03);
                filter: drop-shadow(0 0 20px rgba(108, 44, 156, 0.9));
            }
        }
        
        .jackpot-alert {
            background: linear-gradient(135deg, 
                rgba(115, 190, 40, 0.9) 0%, 
                rgba(255, 210, 63, 0.9) 100%);
            border: 2px solid #73BE28;
            box-shadow: 
                0 0 40px rgba(115, 190, 40, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: jackpot-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes jackpot-glow {
            0% { 
                box-shadow: 0 0 40px rgba(115, 190, 40, 0.6);
                transform: scale(1);
            }
            100% { 
                box-shadow: 0 0 60px rgba(115, 190, 40, 0.8);
                transform: scale(1.02);
            }
        }
        
        .metrics-panel {
            background: 
                radial-gradient(circle at 20% 30%, rgba(139, 69, 19, 0.3) 0%, transparent 50%),
                linear-gradient(145deg, rgba(21, 21, 21, 0.95), rgba(45, 45, 45, 0.9));
            border: 2px solid transparent;
            background-clip: padding-box;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 0 0 1px #8B4513,
                0 8px 32px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(139, 69, 19, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .metric-value {
            background: linear-gradient(45deg, #00D4FF, #6C2C9C, #73BE28);
            background-size: 300% 300%;
            animation: metric-shimmer 3s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes metric-shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 212, 255, 0.8) 50%, 
                transparent 100%);
            animation: line-pulse 2s ease-in-out infinite;
        }
        
        @keyframes line-pulse {
            0%, 100% { opacity: 0.3; transform: scaleX(0.8); }
            50% { opacity: 1; transform: scaleX(1.2); }
        }
        
        .mega-win {
            animation: casino-mega-win 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            border: 4px solid #FFD700 !important;
            box-shadow: 
                0 0 0 2px #FFFFFF,
                0 0 60px rgba(255, 215, 0, 1.5),
                0 0 120px rgba(255, 215, 0, 1),
                0 0 200px rgba(255, 165, 0, 0.6),
                inset 0 0 50px rgba(255, 215, 0, 0.4) !important;
        }
        
        @keyframes casino-mega-win {
            0%, 100% { 
                transform: scale(1) rotate(0deg);
                filter: hue-rotate(0deg) brightness(1);
            }
            25% { 
                transform: scale(1.15) rotate(2deg);
                filter: hue-rotate(30deg) brightness(1.2);
            }
            50% {
                transform: scale(1.1) rotate(0deg);
                filter: hue-rotate(60deg) brightness(1.3);
            }
            75% { 
                transform: scale(1.08) rotate(-2deg);
                filter: hue-rotate(30deg) brightness(1.1);
            }
        }
        
        @keyframes celebrate {
            0% {
                transform: translateY(0) rotate(0deg) scale(0);
                opacity: 1;
                filter: hue-rotate(0deg);
            }
            25% {
                transform: translateY(-25vh) rotate(90deg) scale(1.2);
                opacity: 1;
                filter: hue-rotate(90deg);
            }
            75% {
                transform: translateY(-75vh) rotate(270deg) scale(0.8);
                opacity: 0.8;
                filter: hue-rotate(270deg);
            }
            100% {
                transform: translateY(-100vh) rotate(360deg) scale(0);
                opacity: 0;
                filter: hue-rotate(360deg);
            }
        }
        
        .lever-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .lever {
            width: 90px;
            height: 220px;
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.2) 0%, transparent 40%),
                linear-gradient(145deg, #8B4513 0%, #A0522D 30%, #654321 70%, #4A4A4A 100%);
            border: 4px solid transparent;
            background-clip: padding-box;
            border-radius: 45px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            box-shadow: 
                0 0 0 2px #DAA520,
                0 10px 30px rgba(0, 0, 0, 0.8),
                0 0 25px rgba(218, 165, 32, 0.4),
                inset 0 3px 8px rgba(255, 255, 255, 0.2),
                inset 0 -3px 8px rgba(0, 0, 0, 0.3);
        }
        
        .lever:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 0 0 3px #FFD700,
                0 15px 40px rgba(0, 0, 0, 0.9),
                0 0 35px rgba(255, 215, 0, 0.6),
                inset 0 3px 12px rgba(255, 255, 255, 0.3),
                inset 0 -3px 12px rgba(0, 0, 0, 0.3);
        }
        
        .lever:active {
            transform: translateY(10px);
            box-shadow: 
                0 4px 10px rgba(0, 0, 0, 0.6),
                inset 0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(0, 212, 255, 0.4);
        }
        
        .lever-handle {
            width: 65px;
            height: 65px;
            background: 
                radial-gradient(circle at 25% 25%, #FFFFFF 0%, #FFD700 15%, #DAA520 40%, #B8860B 70%, #8B6914 100%);
            border: 3px solid #FFFFFF;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 6px 15px rgba(0, 0, 0, 0.5),
                0 0 25px rgba(255, 215, 0, 0.8),
                inset 0 3px 8px rgba(255, 255, 255, 0.6),
                inset 0 -3px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .lever-handle::before {
            content: '‚ô¶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #8B4513;
            text-shadow: 
                0 0 10px rgba(255, 255, 255, 0.8),
                0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .lever-pull-text {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(0, 212, 255, 0.9);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .pulling .lever {
            transform: translateY(15px) rotate(5deg);
        }
        
        .control-button {
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.15) 0%, transparent 40%),
                linear-gradient(145deg, rgba(139, 69, 19, 0.9), rgba(160, 82, 45, 0.8));
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow: 
                0 0 0 1px #DAA520,
                0 4px 15px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(218, 165, 32, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        
        .control-button:hover {
            background: 
                radial-gradient(circle at 25% 25%, rgba(255, 255, 255, 0.2) 0%, transparent 40%),
                linear-gradient(145deg, rgba(218, 165, 32, 0.9), rgba(255, 215, 0, 0.8));
            box-shadow: 
                0 0 0 2px #FFD700,
                0 6px 20px rgba(0, 0, 0, 0.7),
                0 0 25px rgba(255, 215, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            color: #8B4513;
        }
    </style>
</head>
<body class="min-h-screen slots-bg text-white font-sans">
    
    <!-- Header -->
    <header class="bg-dt-dark/90 backdrop-blur-md border-b border-dt-cyan/20">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <button onclick="window.location.href='lobby.html'" class="bg-dt-gray hover:bg-dt-light-gray text-white px-4 py-2 rounded-lg font-semibold">
                    ‚Üê Back to Lobby
                </button>
                
                <div class="text-center">
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-dt-cyan via-dt-purple to-dt-green bg-clip-text text-transparent">
                        Quantum Slots
                    </h1>
                </div>
                
                <div class="bg-dt-gray px-4 py-2 rounded-lg">
                    <div class="text-sm text-dt-light-gray">Balance</div>
                    <div class="text-xl font-bold text-dt-yellow">$<span id="balance">1000</span></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Game Area -->
    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-4 gap-6">
            
            <!-- Left Column: Live Metrics & View Payouts -->
            <div class="col-span-1">
                <div class="metrics-panel rounded-xl p-6">
                    <div class="flex items-center space-x-2 mb-6">
                        <div class="w-3 h-3 bg-dt-green rounded-full animate-pulse"></div>
                        <h3 class="text-lg font-semibold text-dt-cyan">Live Metrics</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-dt-light-gray text-sm">Total Spins</span>
                            <span class="metric-value text-lg font-bold" id="totalSpins">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-dt-light-gray text-sm">Wins</span>
                            <span class="metric-value text-lg font-bold" id="totalWins">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-dt-light-gray text-sm">Win Rate</span>
                            <span class="metric-value text-lg font-bold" id="winRate">0%</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-dt-light-gray text-sm">Biggest Win</span>
                            <span class="metric-value text-lg font-bold" id="biggestWin">$0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-dt-light-gray text-sm">Session Profit</span>
                            <span class="metric-value text-lg font-bold" id="sessionProfit">$0</span>
                        </div>
                    </div>
                </div>
                
                <!-- View Payouts Button -->
                <div class="metrics-panel rounded-xl p-6 mt-6">
                    <div class="text-center">
                        <button id="payoutInfoBtn" onclick="openPayoutModal()" class="control-button px-6 py-3 rounded-lg font-semibold text-sm bg-gradient-to-r from-dt-yellow to-dt-orange hover:from-dt-orange hover:to-dt-yellow transition-all duration-300">
                            üí∞ View Payouts
                        </button>
                    </div>
                </div>
            </div>

            <!-- Center Column: Slot Machine -->
            <div class="col-span-2">
                <div class="slot-machine-container rounded-xl p-8 relative">
                            
                            <!-- Jackpot Banner (Hidden by default) -->
                            <div id="jackpotBanner" class="jackpot-alert rounded-lg p-4 mb-6 text-center hidden">
                                <div class="text-2xl font-bold text-white mb-2">üéä JACKPOT! üéä</div>
                                <div class="text-lg text-white" id="jackpotAmount">$0</div>
                                <div class="text-sm text-white/80">Quantum Entanglement Achieved!</div>
                            </div>
                            
                            <!-- Slot Reels -->
                            <div class="relative mb-8">
                                <div class="grid grid-cols-3 gap-6 mb-6">
                                    <div class="slot-reel rounded-xl aspect-square flex items-center justify-center relative" id="reel1">
                                        <div class="slot-symbol" id="symbol1">
                                            <img src="assets/slot-icons/dynatrace.png" alt="Dynatrace" class="w-16 h-16"/>
                                        </div>
                                        <div class="connection-line w-12 -right-6 top-1/2 transform -translate-y-1/2"></div>
                                    </div>
                                    <div class="slot-reel rounded-xl aspect-square flex items-center justify-center relative" id="reel2">
                                        <div class="slot-symbol" id="symbol2">
                                            <img src="assets/slot-icons/dynatrace.png" alt="Dynatrace" class="w-16 h-16"/>
                                        </div>
                                        <div class="connection-line w-12 -right-6 top-1/2 transform -translate-y-1/2"></div>
                                    </div>
                                    <div class="slot-reel rounded-xl aspect-square flex items-center justify-center" id="reel3">
                                        <div class="slot-symbol" id="symbol3">
                                            <img src="assets/slot-icons/dynatrace.png" alt="Dynatrace" class="w-16 h-16"/>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payline Indicator -->
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="w-full h-1 bg-gradient-to-r from-transparent via-dt-yellow to-transparent opacity-50"></div>
                                </div>
                            </div>
                            
                            <!-- Game Controls -->
                            <div class="grid grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <label class="block text-dt-light-gray text-sm font-medium">Bet Amount</label>
                                    <select id="betAmount" class="w-full bg-dt-gray border border-dt-cyan/30 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-dt-cyan">
                                        <option value="10">$10</option>
                                        <option value="25">$25</option>
                                        <option value="50" selected>$50</option>
                                        <option value="100">$100</option>
                                        <option value="250">$250</option>
                                    </select>
                                </div>
                                
                                <div class="space-y-4">
                                    <label class="block text-dt-light-gray text-sm font-medium">Auto Spin</label>
                                    <div class="flex space-x-2">
                                        <button id="autoSpin5" class="control-button px-4 py-2 rounded-lg text-sm flex-1">5x</button>
                                        <button id="autoSpin10" class="control-button px-4 py-2 rounded-lg text-sm flex-1">10x</button>
                                        <button id="stopAuto" class="control-button px-4 py-2 rounded-lg text-sm flex-1 hidden">Stop</button>
                                    </div>
                                </div>
                            </div>
                            
                        <!-- Result Display -->
                        <div id="resultDisplay" class="text-center mt-6 min-h-[2rem]">
                            <span class="text-dt-light-gray">Pull the lever to spin!</span>
                        </div>
                    </div>
                </div>

            <!-- Right Column: Pull Lever & Controls -->
            <div class="col-span-1 space-y-6">
                <!-- Pull Lever -->
                <div class="lever-container">
                    <div class="lever" id="pullLever">
                        <div class="lever-handle">
                            <div class="w-full h-full rounded-full bg-gradient-to-br from-dt-yellow to-dt-orange relative overflow-hidden flex items-center justify-center">
                                <div class="absolute inset-0 bg-gradient-to-br from-white/30 to-transparent"></div>
                                <div class="relative z-10 text-white font-bold text-xl drop-shadow-lg">‚ö°</div>
                            </div>
                        </div>
                        <div class="lever-pull-text">
                            PULL
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <div class="text-sm text-dt-light-gray font-medium">Pull Lever</div>
                        <div class="text-xs text-dt-cyan font-semibold" id="leverStatus">Ready</div>
                    </div>
                </div>
                
                <!-- Accordion Cheat Controls -->
                <div class="w-full space-y-4 bg-dt-darker/80 rounded-lg border border-dt-cyan/30">
                    <div class="text-center p-4 pb-0">
                        <h3 class="text-dt-cyan font-bold text-lg">üéÆ Controls</h3>
                    </div>
                    
                    <!-- Accordion Header -->
                    <div class="px-4">
                        <button id="cheatAccordionToggle" onclick="toggleCheatAccordion()" class="w-full flex items-center justify-between p-3 bg-green-900/20 hover:bg-green-900/30 border border-green-500/30 rounded-lg transition-all duration-300">
                            <div class="flex items-center space-x-3">
                                <span class="text-green-400 font-bold text-sm">Demo Cheat Methods</span>
                                <span class="text-xs text-gray-400 bg-green-900/30 px-2 py-1 rounded">Lab Demo - Free</span>
                            </div>
                            <div id="cheatAccordionIcon" class="text-green-400 transform transition-transform duration-300">
                                ‚ñº
                            </div>
                        </button>
                    </div>
                    
                    <!-- Collapsible Content -->
                    <div id="cheatAccordionContent" class="px-4 pb-4 hidden">
                        <div class="text-center mb-3">
                            <div class="text-xs text-gray-400 mt-1">All methods available for testing</div>
                        </div>
                        
                        <div class="space-y-2">
                            <button id="cheatAlgorithmRig" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-3 py-2 rounded text-xs font-semibold transition-all text-left" onclick="activateCheat('algorithmRig')">
                                <div class="flex items-center justify-between">
                                    <span>üéØ Algorithm Rig</span>
                                    <span class="text-xs text-green-400">FREE</span>
                                </div>
                                <div class="text-xs text-green-400/70 mt-1">50% better odds</div>
                            </button>
                            
                            <button id="cheatSymbolManipulation" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-3 py-2 rounded text-xs font-semibold transition-all text-left" onclick="activateCheat('symbolManipulation')">
                                <div class="flex items-center justify-between">
                                    <span>üîß Symbol Manipulation</span>
                                    <span class="text-xs text-green-400">FREE</span>
                                </div>
                                <div class="text-xs text-green-400/70 mt-1">35% better odds</div>
                            </button>
                            
                            <button id="cheatTimingExploit" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-3 py-2 rounded text-xs font-semibold transition-all text-left" onclick="activateCheat('timingExploit')">
                                <div class="flex items-center justify-between">
                                    <span>‚è∞ Timing Exploit</span>
                                    <span class="text-xs text-green-400">FREE</span>
                                </div>
                                <div class="text-xs text-green-400/70 mt-1">40% better odds</div>
                            </button>
                            
                            <button id="cheatPayoutBoost" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-3 py-2 rounded text-xs font-semibold transition-all text-left" onclick="activateCheat('payoutBoost')">
                                <div class="flex items-center justify-between">
                                    <span>üí∞ Payout Boost</span>
                                    <span class="text-xs text-green-400">FREE</span>
                                </div>
                                <div class="text-xs text-green-400/70 mt-1">25% payout boost</div>
                            </button>
                            
                            <button onclick="deactivateCheat()" class="w-full bg-red-800/60 hover:bg-red-700/70 border border-red-500/50 text-white text-xs py-2 px-3 rounded transition-all">
                                üõë Deactivate Cheat
                            </button>
                        </div>
                        
                        <div id="cheatStatus" class="text-center text-xs text-gray-400 mt-3 pt-3 border-t border-gray-700/50">
                            üéÆ Demo Mode - All Free
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        console.log('üé∞ Slots game loading...');
        
        // Enhanced Game state with persistence
        let balance = parseInt(localStorage.getItem('vegasBalance')) || 1000;
        let isSpinning = false;
        let autoSpinCount = 0;
        let autoSpinActive = false;
        
        // Enhanced session stats
        let sessionStats = JSON.parse(localStorage.getItem('vegas.sessionStats')) || {
            totalSpins: 0,
            totalWins: 0,
            biggestWin: 0,
            sessionProfit: 0
        };
        
        // User data from access control form
        let currentUser = localStorage.getItem('vegas.username') || 'Anonymous';
        // Read customer data from individual localStorage keys set by authentication form
        let customerData = {
            customerName: localStorage.getItem('vegas.customerName') || 'Demo User',
            email: localStorage.getItem('vegas.email') || 'demo@dynatrace.com',
            companyName: localStorage.getItem('vegas.companyName') || 'Dynatrace Demo',
            persona: localStorage.getItem('vegas.persona') || 'Slots Player',
            booth: localStorage.getItem('vegas.booth') || 'Demo Booth 1',
            optIn: localStorage.getItem('vegas.optIn') === 'true' || true
        };
        
        // Function to update customer data (called from access control form)
        window.updateCustomerData = function(data) {
            customerData = { ...customerData, ...data };
            // Store both individual keys and combined object for compatibility
            if (data.customerName) localStorage.setItem('vegas.customerName', data.customerName);
            if (data.email) localStorage.setItem('vegas.email', data.email);
            if (data.companyName) localStorage.setItem('vegas.companyName', data.companyName);
            if (data.persona) localStorage.setItem('vegas.persona', data.persona);
            if (data.booth) localStorage.setItem('vegas.booth', data.booth);
            if (data.optIn !== undefined) localStorage.setItem('vegas.optIn', data.optIn.toString());
            
            localStorage.setItem('vegas.customerData', JSON.stringify(customerData));
            console.log('üìù Customer data updated:', customerData);
        };
        
        // Enhanced Dynatrace Slot Symbols with working structure
        const symbols = [
            { img: 'assets/slot-icons/dynatrace.png', name: 'Dynatrace', value: 100, rarity: 'legendary', color: '#00D4FF' },
            { emoji: 'üåê', name: 'Smartscape', value: 75, rarity: 'epic', color: '#6C2C9C' },
            { emoji: 'üì±', name: 'Application', value: 50, rarity: 'epic', color: '#73BE28' },
            { emoji: 'üóÑÔ∏è', name: 'Database', value: 25, rarity: 'epic', color: '#FFD23F' },
            { emoji: 'üñ•Ô∏è', name: 'Server', value: 20, rarity: 'rare', color: '#00A1C9' },
            { emoji: '‚òÅÔ∏è', name: 'Cloud', value: 15, rarity: 'rare', color: '#FFA86B' },
            { emoji: 'üõ°Ô∏è', name: 'Security', value: 10, rarity: 'rare', color: '#FF6B6B' },
            { emoji: 'üìä', name: 'Analytics', value: 8, rarity: 'rare', color: '#4ECDC4' },
            { emoji: '‚öôÔ∏è', name: 'Services', value: 6, rarity: 'common', color: '#96CEB4' },
            { emoji: 'üè†', name: 'Host', value: 4, rarity: 'common', color: '#FFEAA7' },
            { emoji: 'üîÑ', name: 'Process', value: 3, rarity: 'common', color: '#DDA0DD' },
            { emoji: 'üß†', name: 'CPU', value: 2, rarity: 'common', color: '#F7DC6F' }
        ];
        
        // Balanced Payout Matrix - Matches Server Logic
        const payoutMatrix = {
            triple: {
                'Dynatrace': { multiplier: 100, name: 'QUANTUM JACKPOT!' },        // 0.1% chance
                'Smartscape': { multiplier: 50, name: 'SMARTSCAPE MASTERY!' },     // 0.2% chance  
                'Application': { multiplier: 25, name: 'APP EXCELLENCE!' },       // 0.3% chance
                'Database': { multiplier: 15, name: 'DATA CHAMPION!' },           // 1% chance
                'Server': { multiplier: 12, name: 'SERVER DOMINATION!' },         // 1.5% chance
                'Cloud': { multiplier: 10, name: 'CLOUD CONQUEST!' },             // 2% chance
                'Security': { multiplier: 8, name: 'SECURITY MASTER!' },          // 3% chance
                'Analytics': { multiplier: 6, name: 'ANALYTICS ACE!' },           // 3% chance
                'Services': { multiplier: 5, name: 'SERVICE STAR!' },             // 4% chance
                'Host': { multiplier: 4, name: 'HOST HERO!' },                    // 5% chance
                'Process': { multiplier: 3, name: 'PROCESS PRO!' },               // 6% chance
                'CPU': { multiplier: 2, name: 'CPU CHAMPION!' }                   // 7% chance
            },
            double: {
                'Dynatrace': { multiplier: 10, name: 'Dynatrace Power!' },        // 2% chance
                'Smartscape': { multiplier: 6, name: 'Smartscape Sync!' },        // 3% chance
                'Application': { multiplier: 4, name: 'App Boost!' },             // 4% chance
                'Database': { multiplier: 3, name: 'Data Duo!' },                 // 5% chance
                'Server': { multiplier: 2, name: 'Server Pair!' },                // 6% chance
                'Cloud': { multiplier: 2, name: 'Cloud Combo!' },                 // 6% chance
                'Security': { multiplier: 1.5, name: 'Shield Sync!' },            // 7% chance
                'Analytics': { multiplier: 1.5, name: 'Chart Pair!' },            // 7% chance
                'Services': { multiplier: 1.5, name: 'Service Match!' },          // 8% chance
                'Host': { multiplier: 1.5, name: 'Host Pair!' },                  // 8% chance
                'Process': { multiplier: 1.5, name: 'Process Match!' },           // 8% chance
                'CPU': { multiplier: 1.5, name: 'CPU Pair!' }                     // 8% chance
            },
            special: {
                'Dynatrace_Smartscape_Application': { multiplier: 150, name: 'FULL STACK MASTERY!' },    // 0.01% chance
                'Dynatrace_Database_Security': { multiplier: 125, name: 'CORE SECURITY!' },             // 0.02% chance  
                'Smartscape_Server_Cloud': { multiplier: 100, name: 'CLOUD ARCHITECTURE!' },           // 0.05% chance
                'Analytics_CPU_Process': { multiplier: 75, name: 'PERFORMANCE TRINITY!' }               // 0.1% chance
            }
        };
        
        // Cheating System
        let cheatState = {
            active: null,
            winBoost: 1.0,
            detectionRisk: 0
        };
        
        const cheatMethods = {
            algorithmRig: { 
                name: 'Algorithm Rig', 
                winBoost: 1.5, 
                detectionRisk: 15,
                description: 'Hack quantum randomizer algorithms'
            },
            symbolManipulation: { 
                name: 'Symbol Manipulation', 
                winBoost: 1.35, 
                detectionRisk: 20,
                description: 'Manipulate reel symbol positions'
            },
            timingExploit: { 
                name: 'Timing Exploit', 
                winBoost: 1.4, 
                detectionRisk: 25,
                description: 'Perfect timing for jackpot window'
            },
            payoutBoost: { 
                name: 'Payout Boost', 
                winBoost: 1.25, 
                detectionRisk: 10,
                description: 'Boost all payout multipliers'
            }
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ Quantum Slots loading...');
            updateDisplay();
            updateCheatUI();
            
            // Add lever click handler - KEEP THIS SIMPLE AND WORKING
            const lever = document.getElementById('pullLever');
            if (lever) {
                lever.addEventListener('click', pullLever);
                console.log('‚úÖ Lever click handler attached');
            }
            
            // Add auto-spin handlers
            const autoSpin5 = document.getElementById('autoSpin5');
            const autoSpin10 = document.getElementById('autoSpin10');
            const stopAuto = document.getElementById('stopAuto');
            
            if (autoSpin5) autoSpin5.addEventListener('click', () => startAutoSpin(5));
            if (autoSpin10) autoSpin10.addEventListener('click', () => startAutoSpin(10));
            if (stopAuto) stopAuto.addEventListener('click', stopAutoSpin);
            
            // Entrance animations
            if (typeof gsap !== 'undefined') {
                gsap.from('.slot-machine-container', {
                    duration: 1,
                    y: 50,
                    opacity: 0,
                    ease: "power3.out"
                });
                
                gsap.from('.metrics-panel', {
                    duration: 1,
                    x: -50,
                    opacity: 0,
                    ease: "power3.out",
                    delay: 0.2
                });
                
                gsap.from('.lever-container', {
                    duration: 1,
                    x: 50,
                    opacity: 0,
                    ease: "power3.out",
                    delay: 0.4
                });
            }
        });
        
        // Cheat System Functions
        function activateCheat(cheatType) {
            const cheat = cheatMethods[cheatType];
            if (!cheat) return;
            
            cheatState.active = cheatType;
            cheatState.winBoost = cheat.winBoost;
            cheatState.detectionRisk = cheat.detectionRisk;
            
            updateCheatUI();
            showNotification(`${cheat.name} activated! Win boost: +${Math.round((cheat.winBoost - 1) * 100)}%`, 'success');
            
            // Auto-deactivate after 30 seconds
            setTimeout(() => {
                if (cheatState.active === cheatType) {
                    deactivateCheat();
                }
            }, 30000);
        }
        
        function deactivateCheat() {
            if (!cheatState.active) return;
            
            cheatState.active = null;
            cheatState.winBoost = 1.0;
            updateCheatUI();
            showNotification('Cheat deactivated', 'info');
        }
        
        // Accordion toggle for cheat controls
        function toggleCheatAccordion() {
            const content = document.getElementById('cheatAccordionContent');
            const icon = document.getElementById('cheatAccordionIcon');
            
            if (!content || !icon) return;
            
            const isHidden = content.classList.contains('hidden');
            
            if (isHidden) {
                // Show content
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                
                // Animate in with GSAP if available
                if (typeof gsap !== 'undefined') {
                    gsap.from(content, {
                        duration: 0.3,
                        height: 0,
                        opacity: 0,
                        ease: "power2.out"
                    });
                }
            } else {
                // Hide content with animation
                if (typeof gsap !== 'undefined') {
                    gsap.to(content, {
                        duration: 0.3,
                        height: 0,
                        opacity: 0,
                        ease: "power2.in",
                        onComplete: () => {
                            content.classList.add('hidden');
                            content.style.height = 'auto';
                            content.style.opacity = '1';
                        }
                    });
                } else {
                    content.classList.add('hidden');
                }
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function updateCheatUI() {
            const buttons = ['cheatAlgorithmRig', 'cheatSymbolManipulation', 'cheatTimingExploit', 'cheatPayoutBoost'];
            const types = ['algorithmRig', 'symbolManipulation', 'timingExploit', 'payoutBoost'];
            
            buttons.forEach((buttonId, index) => {
                const button = document.getElementById(buttonId);
                if (!button) return;
                
                const cheatType = types[index];
                const cheat = cheatMethods[cheatType];
                
                if (cheatState.active === cheatType) {
                    button.classList.add('bg-red-600', 'animate-pulse');
                    button.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>üî• ACTIVE</span>
                            <span class="text-xs text-red-400">ACTIVE</span>
                        </div>
                        <div class="text-xs text-red-400/70 mt-1">${cheat.name} Running</div>
                    `;
                } else {
                    button.classList.remove('bg-red-600', 'animate-pulse');
                    const icons = ['üéØ', 'üîß', '‚è∞', 'üí∞'];
                    button.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span>${icons[index]} ${cheat.name.split(' ')[0]}</span>
                            <span class="text-xs text-green-400">FREE</span>
                        </div>
                        <div class="text-xs text-green-400/70 mt-1">${Math.round((cheat.winBoost - 1) * 100)}% better odds</div>
                    `;
                }
            });
            
            // Update status
            const statusEl = document.getElementById('cheatStatus');
            if (statusEl) {
                if (cheatState.active) {
                    const activeCheat = cheatMethods[cheatState.active];
                    statusEl.innerHTML = `üî• ${activeCheat.name} Active`;
                    statusEl.className = 'text-center text-xs text-red-300 mt-3 pt-3 border-t border-gray-700/50';
                } else {
                    statusEl.innerHTML = 'üéÆ Demo Mode - All Free';
                    statusEl.className = 'text-center text-xs text-gray-400 mt-3 pt-3 border-t border-gray-700/50';
                }
            }
        }
        
        function startAutoSpin(count) {
            if (isSpinning) return;
            
            autoSpinCount = count;
            autoSpinActive = true;
            
            document.getElementById('autoSpin5').classList.add('hidden');
            document.getElementById('autoSpin10').classList.add('hidden');
            document.getElementById('stopAuto').classList.remove('hidden');
            
            autoSpinNext();
        }

        function autoSpinNext() {
            if (!autoSpinActive || autoSpinCount <= 0) {
                stopAutoSpin();
                return;
            }
            
            if (!isSpinning) {
                pullLever();
                autoSpinCount--;
            }
            
            setTimeout(autoSpinNext, 3000);
        }

        function stopAutoSpin() {
            autoSpinActive = false;
            autoSpinCount = 0;
            
            document.getElementById('autoSpin5').classList.remove('hidden');
            document.getElementById('autoSpin10').classList.remove('hidden');
            document.getElementById('stopAuto').classList.add('hidden');
        }
        
        function pullLever() {
            if (isSpinning) return;
            
            console.log('üé∞ Pull lever clicked!');
            const betAmount = parseInt(document.getElementById('betAmount').value);
            
            if (betAmount > balance) {
                showMessage('Insufficient balance!', 'error');
                return;
            }
            
            // Deduct bet
            balance -= betAmount;
            isSpinning = true;
            
            updateDisplay();
            showMessage('Spinning...', 'info');
            
            // Update status elements if they exist
            const leverStatus = document.getElementById('leverStatus');
            if (leverStatus) leverStatus.textContent = 'Spinning...';
            
            console.log('üé∞ Starting spin with bet amount:', betAmount);
            
            // Start spinning animation
            spin(betAmount);
        }
        
        function spin(betAmount) {
            console.log('üé∞ Starting spin animation with bet:', betAmount);
            
            const reels = document.querySelectorAll('.slot-reel');
            const symbolElements = document.querySelectorAll('.slot-symbol');
            
            console.log('üé∞ Found', reels.length, 'reels and', symbolElements.length, 'symbols');
            
            // Add spinning class
            reels.forEach((reel, index) => {
                reel.classList.add('spinning');
                console.log(`üé∞ Added spinning class to reel ${index + 1}`);
            });
            
            let spinCounter = 0;
            const maxSpins = 30;

            console.log('üé∞ Starting spin interval with maxSpins:', maxSpins);

            // Fire a backend spin request so RUM/APM (Dynatrace) can capture it.
            // We don't block the UI; we'll use the server response when the animation ends.
            window.__lastSpinResponse = null;
            fetch('/api/slots/spin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    Username: currentUser,
                    BetAmount: betAmount,
                    CheatActive: cheatState.active ? true : false,
                    CheatType: cheatState.active || null,
                    // Use customer data from access control form
                    CustomerName: customerData.customerName,
                    Email: customerData.email,
                    CompanyName: customerData.companyName,
                    Persona: customerData.persona,
                    Booth: customerData.booth,
                    OptIn: customerData.optIn,
                    // Session tracking
                    CorrelationId: 'slot-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    DetectionRisk: cheatState.active ? 25 : 0,
                    CheatActivationsToday: cheatState.active ? 1 : 0,
                    CheatDetails: cheatState.active ? cheatMethods[cheatState.active] : null
                })
            }).then(r => r.json())
            .then(data => {
                window.__lastSpinResponse = data;
                console.log('üé∞ Received server spin response:', data);
                console.log('üé∞ Response keys:', Object.keys(data));
                console.log('üé∞ Customer data:', {
                    CustomerName: data.CustomerName,
                    Email: data.Email,
                    CompanyName: data.CompanyName,
                    Persona: data.Persona,
                    CorrelationId: data.CorrelationId,
                    JackpotFlag: data.JackpotFlag,
                    CheatDetails: data.CheatDetails
                });
            }).catch(err => {
                console.error('üé∞ Spin request failed:', err);
            });

            const spinInterval = setInterval(() => {
                // Update each symbol with random symbols during spin
                symbolElements.forEach((symbolEl, index) => {
                    const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                    
                    if (randomSymbol.img) {
                        symbolEl.innerHTML = `<img src="${randomSymbol.img}" alt="${randomSymbol.name}" class="w-16 h-16"/>`;
                    } else {
                        symbolEl.innerHTML = `<div style="font-size: 4rem;">${randomSymbol.emoji}</div>`;
                    }
                });

                spinCounter++;

                if (spinCounter >= maxSpins) {
                    console.log(`üé∞ Spin counter reached ${spinCounter}, clearing interval`);
                    clearInterval(spinInterval);
                    // Pass server response if available so we use server-calculated result
                    stopSpin(betAmount, window.__lastSpinResponse);
                }
            }, 100);
        }
        
        function stopSpin(betAmount, serverResponse = null) {
            console.log('üé∞ stopSpin called with betAmount:', betAmount, 'serverResponse:', serverResponse);
            
            const reels = document.querySelectorAll('.slot-reel');
            const symbolElements = document.querySelectorAll('.slot-symbol');
            
            console.log('üé∞ Removing spinning class from', reels.length, 'reels');
            
            // Remove spinning class
            reels.forEach((reel, index) => {
                reel.classList.remove('spinning');
                console.log(`üé∞ Removed spinning class from reel ${index + 1}`);
            });

            // If server returned a result, use it (preferred) so traces align with backend
            if (serverResponse && Array.isArray(serverResponse.result)) {
                const finalSymbols = [];
                console.log('üé∞ Using server-provided result:', serverResponse.result);

                for (let i = 0; i < 3; i++) {
                    const name = serverResponse.result[i];
                    // Enhanced symbol matching - map server names to frontend symbols
                    let symbolObj = symbols.find(s => s.name && s.name.toLowerCase() === name.toLowerCase());
                    
                    // If no exact match, try partial matching or use defaults
                    if (!symbolObj) {
                        const symbolMap = {
                            'dynatrace': symbols.find(s => s.img && s.img.includes('dynatrace')) || symbols[0],
                            'smartscape': symbols.find(s => s.name === 'Smartscape') || symbols[1],
                            'application': symbols.find(s => s.name === 'Application') || symbols[2],
                            'database': symbols.find(s => s.name === 'Database') || symbols[3],
                            'server': symbols.find(s => s.name === 'Server') || symbols[4],
                            'cloud': symbols.find(s => s.name === 'Cloud') || symbols[5],
                            'shield': symbols.find(s => s.name === 'Security') || symbols[6],
                            'chart': symbols.find(s => s.name === 'Analytics') || symbols[7],
                            'network': symbols.find(s => s.name === 'Services') || symbols[8],
                            'services': symbols.find(s => s.name === 'Services') || symbols[8],
                            'host': symbols.find(s => s.name === 'Host') || symbols[9],
                            'process': symbols.find(s => s.name === 'Process') || symbols[10],
                            'memory': symbols.find(s => s.name === 'CPU') || symbols[11],
                            'cpu': symbols.find(s => s.name === 'CPU') || symbols[11]
                        };
                        symbolObj = symbolMap[name.toLowerCase()] || symbols[0]; // Default to first symbol
                    }
                    
                    finalSymbols.push(symbolObj);

                    const symbolEl = symbolElements[i];
                    if (symbolObj.img) {
                        symbolEl.innerHTML = `<img src="${symbolObj.img}" alt="${symbolObj.name}" class="w-16 h-16"/>`;
                    } else {
                        symbolEl.innerHTML = `<div style="font-size: 4rem;">${symbolObj.emoji}</div>`;
                    }
                }

                // Apply server-declared win state - handle both old and new format
                const winAmount = serverResponse.WinningAmount || serverResponse.winAmount || 0;
                const win = serverResponse.WinFlag === 1 || serverResponse.win || false;
                const winType = serverResponse.winType || (win ? 'win' : '');
                const description = serverResponse.description || (win ? 'Winner!' : '');
                
                // Update balance from server response
                if (serverResponse.Balance !== undefined) {
                    balance = serverResponse.Balance;
                }

                sessionStats.totalSpins++;

                if (win && winAmount > 0) {
                    sessionStats.totalWins++;
                    if (winAmount > sessionStats.biggestWin) sessionStats.biggestWin = winAmount;

                    if (winAmount >= 1000) {
                        showJackpotBanner(winAmount, `${description} $${winAmount}`);
                        createCelebrationEffect();
                    } else {
                        showMessage(`${winType === 'special' ? 'üíé' : 'ÔøΩ'} ${description} $${winAmount}`, 'success');
                    }

                    // Add winning animation
                    document.querySelectorAll('.slot-reel').forEach(reel => {
                        reel.classList.add('winning-reel');
                        if (winType === 'special' || winAmount >= 1000) {
                            reel.classList.add('mega-win');
                        }
                    });

                    setTimeout(() => {
                        document.querySelectorAll('.slot-reel').forEach(reel => {
                            reel.classList.remove('winning-reel', 'mega-win');
                        });
                    }, 3000);
                } else {
                    showMessage('üé∞ Try again! Keep spinning for big wins!', 'info');
                }

                // Update session profit (server already handles bet deduction)
                sessionStats.sessionProfit = balance - 1000; // Assuming 1000 starting balance
                localStorage.setItem('vegas.sessionStats', JSON.stringify(sessionStats));
                localStorage.setItem('vegasBalance', String(balance));

                updateDisplay();
                isSpinning = false;

                const leverStatus = document.getElementById('leverStatus');
                if (leverStatus) leverStatus.textContent = 'Ready';

                console.log('üé∞ stopSpin completed using server response');
                return;
            }

            // Fallback: no server response ‚Äî use existing client-side random generation
            // Generate final result
            const finalSymbols = [];
            console.log('üé∞ Generating final symbols (client fallback)...');

            for (let i = 0; i < 3; i++) {
                const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                finalSymbols.push(randomSymbol);

                console.log(`üé∞ Final symbol ${i + 1}:`, randomSymbol.name);

                const symbolEl = symbolElements[i];
                if (randomSymbol.img) {
                    symbolEl.innerHTML = `<img src="${randomSymbol.img}" alt="${randomSymbol.name}" class="w-16 h-16"/>`;
                } else {
                    symbolEl.innerHTML = `<div style="font-size: 4rem;">${randomSymbol.emoji}</div>`;
                }
            }

            console.log('üé∞ Final symbols generated:', finalSymbols.map(s => s.name));

            // Check for wins using existing client logic
            console.log('üé∞ Calling checkWin...');
            checkWin(finalSymbols, betAmount);

            isSpinning = false;
            console.log('üé∞ Set isSpinning to false (fallback)');

            // Update status elements if they exist
            const leverStatus = document.getElementById('leverStatus');
            if (leverStatus) {
                leverStatus.textContent = 'Ready';
                console.log('üé∞ Updated lever status to Ready (fallback)');
            }

            console.log('üé∞ stopSpin completed (fallback)');
        }
        
        function checkWin(finalSymbols, betAmount) {
            console.log('üé∞ Checking win:', finalSymbols);
            
            const symbol1 = finalSymbols[0];
            const symbol2 = finalSymbols[1];
            const symbol3 = finalSymbols[2];
            
            let winAmount = 0;
            let winMessage = '';
            let winType = '';
            
            // Check for special combinations first
            const sortedNames = [symbol1.name, symbol2.name, symbol3.name].sort().join('_');
            for (const [combo, payout] of Object.entries(payoutMatrix.special)) {
                if (sortedNames === combo.replace(/_/g, '_')) {
                    winAmount = betAmount * payout.multiplier;
                    winMessage = `üíé ${payout.name} $${winAmount}`;
                    winType = 'special';
                    break;
                }
            }
            
            // Check for triple matches
            if (!winAmount && symbol1.name === symbol2.name && symbol2.name === symbol3.name) {
                const payout = payoutMatrix.triple[symbol1.name];
                if (payout) {
                    winAmount = betAmount * payout.multiplier;
                    winMessage = `üéä ${payout.name} $${winAmount}`;
                    winType = 'triple';
                }
            }
            
            // Check for double matches
            if (!winAmount && (symbol1.name === symbol2.name || symbol2.name === symbol3.name || symbol1.name === symbol3.name)) {
                const matchedSymbol = symbol1.name === symbol2.name ? symbol1 : 
                                   symbol2.name === symbol3.name ? symbol2 : symbol1;
                const payout = payoutMatrix.double[matchedSymbol.name];
                if (payout) {
                    winAmount = betAmount * payout.multiplier;
                    winMessage = `‚ú® ${payout.name} $${winAmount}`;
                    winType = 'double';
                }
            }
            
            // Apply cheat boost
            if (winAmount > 0 && cheatState.active) {
                const originalAmount = winAmount;
                winAmount = Math.floor(winAmount * cheatState.winBoost);
                console.log(`üéØ Cheat boost applied: $${originalAmount} ‚Üí $${winAmount}`);
                winMessage += ` (üéØ CHEAT BOOST!)`;
            }
            
            // Update game state
            sessionStats.totalSpins++;
            
            if (winAmount > 0) {
                balance += winAmount;
                sessionStats.totalWins++;
                if (winAmount > sessionStats.biggestWin) {
                    sessionStats.biggestWin = winAmount;
                }
                
                // Show enhanced win effects
                if (winAmount >= 1000) {
                    showJackpotBanner(winAmount, winMessage);
                    createCelebrationEffect();
                } else {
                    showMessage(winMessage, 'success');
                }
                
                // Add winning animation based on win type
                document.querySelectorAll('.slot-reel').forEach(reel => {
                    reel.classList.add('winning-reel');
                    if (winType === 'special' || winAmount >= 1000) {
                        reel.classList.add('mega-win');
                    }
                });
                
                setTimeout(() => {
                    document.querySelectorAll('.slot-reel').forEach(reel => {
                        reel.classList.remove('winning-reel', 'mega-win');
                    });
                }, 3000);
                
            } else {
                showMessage('üé∞ Try again! Keep spinning for big wins!', 'info');
            }
            
            // Update session profit
            sessionStats.sessionProfit += (winAmount - betAmount);
            
            // Save session stats
            localStorage.setItem('vegas.sessionStats', JSON.stringify(sessionStats));
            localStorage.setItem('vegasBalance', String(balance));
            
            updateDisplay();
        }
        
        function showJackpotBanner(amount, message) {
            const banner = document.getElementById('jackpotBanner');
            const amountEl = document.getElementById('jackpotAmount');
            
            if (banner && amountEl) {
                banner.classList.remove('hidden');
                amountEl.innerHTML = `
                    <div class="text-3xl font-bold text-white mb-2">${message}</div>
                    <div class="text-2xl text-white">$${amount.toLocaleString()}</div>
                `;
                
                setTimeout(() => {
                    banner.classList.add('hidden');
                }, 5000);
            }
        }
        
        function createCelebrationEffect() {
            // Create floating celebration particles
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: fixed;
                    width: 8px;
                    height: 8px;
                    background: linear-gradient(45deg, #FFD23F, #73BE28, #00D4FF);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    left: ${Math.random() * 100}vw;
                    top: 100vh;
                    animation: celebrate 3s ease-out forwards;
                `;
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 3000);
            }
        }
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('winMessage');
            messageEl.innerHTML = `<span class="text-lg font-semibold ${
                type === 'success' ? 'text-dt-green' : 
                type === 'error' ? 'text-red-400' : 'text-dt-cyan'
            }">${message}</span>`;
        }
        
        function updateDisplay() {
            document.getElementById('balance').textContent = balance;
            document.getElementById('totalSpins').textContent = sessionStats.totalSpins;
            document.getElementById('totalWins').textContent = sessionStats.totalWins;
            document.getElementById('biggestWin').textContent = `$${sessionStats.biggestWin}`;
            document.getElementById('sessionProfit').textContent = `$${sessionStats.sessionProfit}`;
            
            // Update win rate
            const winRateEl = document.getElementById('winRate');
            if (winRateEl) {
                const winRate = sessionStats.totalSpins > 0 ? 
                    ((sessionStats.totalWins / sessionStats.totalSpins) * 100).toFixed(1) : '0.0';
                winRateEl.textContent = `${winRate}%`;
            }
        }
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('resultDisplay');
            if (messageEl) {
                messageEl.innerHTML = `<span class="text-lg font-semibold ${
                    type === 'success' ? 'text-dt-green' : 
                    type === 'error' ? 'text-red-400' : 'text-dt-cyan'
                }">${message}</span>`;
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg border backdrop-blur-md ${
                type === 'success' ? 'bg-dt-green/90 border-dt-green text-white' :
                type === 'error' ? 'bg-red-500/90 border-red-500 text-white' :
                'bg-dt-blue/90 border-dt-blue text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            if (typeof gsap !== 'undefined') {
                gsap.from(notification, {
                    duration: 0.3,
                    x: 100,
                    opacity: 0,
                    ease: "power2.out"
                });
                
                setTimeout(() => {
                    gsap.to(notification, {
                        duration: 0.3,
                        x: 100,
                        opacity: 0,
                        ease: "power2.in",
                        onComplete: () => notification.remove()
                    });
                }, 4000);
            } else {
                setTimeout(() => notification.remove(), 4000);
            }
        }
        
        // Enhanced Payout Modal Functions
        function openPayoutModal() {
            // Create modal dynamically if it doesn't exist
            let modal = document.getElementById('payoutModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'payoutModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
                modal.innerHTML = createPayoutModalContent();
                document.body.appendChild(modal);
                
                // Add click outside to close
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePayoutModal();
                    }
                });
            }
            
            // Ensure modal is visible and reset any GSAP transforms
            modal.classList.remove('hidden');
            modal.style.display = '';  // Remove any inline display styling
            
            // Reset any previous transforms and add entrance animation
            if (typeof gsap !== 'undefined') {
                const modalContent = modal.querySelector('.bg-dt-dark');
                if (modalContent) {
                    // Reset transforms first
                    gsap.set(modalContent, { scale: 1, opacity: 1 });
                    // Then apply entrance animation
                    gsap.fromTo(modalContent, 
                        { scale: 0.9, opacity: 0 },
                        { duration: 0.3, scale: 1, opacity: 1, ease: "power2.out" }
                    );
                }
            }
        }
        
        function createPayoutModalContent() {
            // Helper function to get symbol display
            function getSymbolDisplay(symbolName) {
                const symbol = symbols.find(s => s.name === symbolName);
                if (!symbol) return '‚ùì';
                
                if (symbol.img) {
                    return `<img src="${symbol.img}" alt="${symbol.name}" class="w-6 h-6 inline-block"/>`;
                } else {
                    return `<span style="color: ${symbol.color}">${symbol.emoji}</span>`;
                }
            }
            
            return `
                <div class="bg-dt-dark rounded-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto shadow-2xl border border-dt-cyan/30">
                    <!-- Header -->
                    <div class="sticky top-0 bg-dt-dark rounded-t-xl p-6 border-b border-dt-light-gray/20 backdrop-blur-md">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-dt-yellow to-dt-orange rounded-full flex items-center justify-center">
                                    <span class="text-xl">üí∞</span>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-dt-yellow">Quantum Slots Payouts</h2>
                                    <p class="text-sm text-dt-light-gray">Complete payout matrix and winning combinations</p>
                                </div>
                            </div>
                            <button onclick="closePayoutModal()" class="text-dt-light-gray hover:text-white transition-colors p-2 hover:bg-dt-gray/50 rounded-lg">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Condensed Payout Grid -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- Triple & Double Matches -->
                            <div class="metrics-panel rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-dt-yellow mb-3 flex items-center">
                                    <span class="w-6 h-6 bg-dt-yellow rounded-full flex items-center justify-center text-black text-xs font-bold mr-2">3</span>
                                    Triple Matches
                                </h3>
                                <div class="space-y-1 text-sm">
                                    ${Object.entries(payoutMatrix.triple).slice(0, 6).map(([symbol, payout]) => `
                                        <div class="flex justify-between items-center py-1">
                                            <div class="flex items-center space-x-1">
                                                ${getSymbolDisplay(symbol)} ${getSymbolDisplay(symbol)} ${getSymbolDisplay(symbol)}
                                                <span class="text-xs text-dt-light-gray ml-1">${symbol}</span>
                                            </div>
                                            <span class="font-bold text-dt-yellow">${payout.multiplier}x</span>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <h3 class="text-lg font-semibold text-dt-cyan mt-4 mb-3 flex items-center">
                                    <span class="w-6 h-6 bg-dt-cyan rounded-full flex items-center justify-center text-black text-xs font-bold mr-2">2</span>
                                    Double Matches
                                </h3>
                                <div class="space-y-1 text-sm">
                                    ${Object.entries(payoutMatrix.double).slice(0, 6).map(([symbol, payout]) => `
                                        <div class="flex justify-between items-center py-1">
                                            <div class="flex items-center space-x-1">
                                                ${getSymbolDisplay(symbol)} ${getSymbolDisplay(symbol)} <span class="text-dt-light-gray text-xs">+</span>
                                                <span class="text-xs text-dt-light-gray ml-1">${symbol}</span>
                                            </div>
                                            <span class="font-bold text-dt-cyan">${payout.multiplier}x</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Special Combos & Info -->
                            <div class="metrics-panel rounded-lg p-4">
                                <h3 class="text-lg font-semibold text-dt-purple mb-3 flex items-center">
                                    <span class="w-6 h-6 bg-dt-purple rounded-full flex items-center justify-center text-xs mr-2">üíé</span>
                                    Special Combos
                                </h3>
                                <div class="space-y-2 text-sm">
                                    ${Object.entries(payoutMatrix.special).map(([combo, payout]) => {
                                        const symbols = combo.split('_');
                                        return `
                                            <div class="flex justify-between items-center py-1 bg-dt-purple/10 rounded px-2">
                                                <div class="flex items-center space-x-1">
                                                    ${getSymbolDisplay(symbols[0])} ${getSymbolDisplay(symbols[1])} ${getSymbolDisplay(symbols[2])}
                                                </div>
                                                <div class="text-right">
                                                    <div class="font-bold text-dt-purple">${payout.multiplier}x</div>
                                                    <div class="text-xs text-dt-green">${payout.name}</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <!-- Quick Stats -->
                                <div class="mt-4 pt-3 border-t border-dt-light-gray/20">
                                    <h4 class="text-sm font-semibold text-dt-green mb-2">Win Rates</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-dt-light-gray">Base Rate:</span>
                                            <span class="text-dt-cyan">~25%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-dt-light-gray">With Cheats:</span>
                                            <span class="text-dt-yellow">~60%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-dt-light-gray">Jackpots:</span>
                                            <span class="text-dt-orange">~1%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-dt-light-gray">Specials:</span>
                                            <span class="text-dt-purple">~0.2%</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 p-2 bg-dt-green/20 rounded text-center">
                                        <div class="text-xs text-dt-green font-medium">üí° Use Demo Cheats for Better Odds!</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
            `;
        }
        
        function closePayoutModal() {
            const modal = document.getElementById('payoutModal');
            if (modal) {
                if (typeof gsap !== 'undefined') {
                    const modalContent = modal.querySelector('.bg-dt-dark');
                    if (modalContent) {
                        gsap.to(modalContent, {
                            duration: 0.2,
                            scale: 0.9,
                            opacity: 0,
                            ease: "power2.in",
                            onComplete: () => {
                                modal.classList.add('hidden');
                                // Reset transforms for next opening
                                gsap.set(modalContent, { scale: 1, opacity: 1 });
                            }
                        });
                    } else {
                        modal.classList.add('hidden');
                    }
                } else {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            }
        }
        
        console.log('‚úÖ Slots game ready!');
    </script>
</body>
</html>